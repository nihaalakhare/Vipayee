package com.example.vipayee.activities;

import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.speech.tts.TextToSpeech;
import android.util.Log;
import android.view.GestureDetector;
import android.view.MotionEvent;
import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;
import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import org.json.JSONObject;
import com.example.vipayee.AppConstants;
import com.example.vipayee.R;
import com.example.vipayee.api.ApiClient;
import com.example.vipayee.crypto.GCMUtil;
import com.example.vipayee.utils.BaseActivity;
import com.example.vipayee.utils.DeviceInfoUtil;
import com.example.vipayee.utils.HeaderUtil;
import com.example.vipayee.utils.SessionManager;

import java.util.Locale;
import java.util.Map;


import okhttp3.ResponseBody;

public class HomeActivity extends BaseActivity {

    private GestureDetector gestureDetector;
    private TextToSpeech tts;

    private Handler idleHandler = new Handler();
    private Runnable idleRunnable;

    private static final long IDLE_TIME = 10_000; // 10 seconds
    private static final int MAX_IDLE_SPEAK = 3;

    private int idleSpeakCount = 0;
    private boolean isHomeVisible = false;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_home);

        SessionManager session = new SessionManager(this);

        if (!session.isLoggedIn()) {
            session.clearProfile();
            redirectToMpin();
            return;
        }

        if (session.getProfileId() == null ||
                session.getProfileId().isEmpty()) {

            fetchProfile();
        }

        gestureDetector = new GestureDetector(this, new SwipeListener());
        initTts();
        setupIdleWatcher();
    }

    /* ===================== TTS ===================== */

    private void initTts() {
        tts = new TextToSpeech(this, status -> {
            if (status == TextToSpeech.SUCCESS) {
                tts.setLanguage(new Locale("en", "IN"));
                speakInstructions();
                resetIdleTimer();
            }
        });
    }
    private void stopTts() {
        if (tts != null && tts.isSpeaking()) {
            tts.stop();
        }
    }


    private void speakInstructions() {
        speak(
                "Swipe up for transactions " +
                        "Swipe left for mini statement " +
                        "Swipe right to check balance"
        );
    }

    private void speak(String msg) {
        if (tts != null) {
            tts.speak(msg, TextToSpeech.QUEUE_FLUSH, null, null);
        }
    }

    /* ===================== IDLE HANDLING ===================== */

    private void setupIdleWatcher() {
        idleRunnable = () -> {

            if (!isHomeVisible) return;

            idleSpeakCount++;

            if (idleSpeakCount <= MAX_IDLE_SPEAK) {
                speakInstructions();
                resetIdleTimer();
            } else {
                // Let BaseActivity expire session globally
            }
        };
    }
    private void fetchProfile() {

        try {

            SessionManager session = new SessionManager(this);

            String mobile = session.getMobile();
            String custId = session.getCustId();

            Map<String, String> headers =
                    HeaderUtil.baseHeaders(
                            DeviceInfoUtil.getDeviceInfo(this),
                            AppConstants.getApiKey()
                    );

            headers.put("action", "GET_PROFILE");
            headers.put("auth_token", session.getAuthToken());
            HeaderUtil.addSecurityHeaders(headers);

            ApiClient.create()
                    .getProfile(mobile, custId, headers)
                    .enqueue(new Callback<ResponseBody>() {

                        @Override
                        public void onResponse(
                                @NonNull Call<ResponseBody> call,
                                @NonNull Response<ResponseBody> response) {

                            handleProfileResponse(response);
                        }

                        @Override
                        public void onFailure(
                                @NonNull Call<ResponseBody> call,
                                @NonNull Throwable t) {

                            Log.e("HOME", "Profile fetch failed", t);
                        }
                    });

        } catch (Exception e) {
            Log.e("HOME", "fetchProfile error", e);
        }
    }

    private void handleProfileResponse(
            retrofit2.Response<ResponseBody> response) {

        try {

            // âœ… Step 1: Basic HTTP validation
            if (!response.isSuccessful() || response.body() == null) {
                Log.e("HOME", "Profile API failed. Code: " + response.code());
                return;
            }

            // âœ… Step 2: Read raw response
            String raw = response.body().string();
            Log.d("HOME", "PROFILE RAW: " + raw);

            if (raw == null || raw.trim().isEmpty()) {
                Log.e("HOME", "Empty profile response");
                return;
            }

            // âœ… Step 3: Parse outer wrapper
            JSONObject wrapper = new JSONObject(raw);

            String outerResponseCode =
                    wrapper.optString("response_code", "0");

            if (!outerResponseCode.equals("1")) {
                Log.e("HOME", "Outer response_code not 1: " + wrapper);
                return;
            }

            // âœ… Step 4: Extract encrypted response
            String encryptedResponse =
                    wrapper.optString("response", null);

            if (encryptedResponse == null ||
                    encryptedResponse.isEmpty()) {

                Log.e("HOME", "Encrypted response missing");
                return;
            }

            // ðŸ” Step 5: Decrypt AES response
            String decrypted = GCMUtil.decrypt(
                    encryptedResponse,
                    AppConstants.getSecretKeyBytes()
            );

            Log.d("HOME", "PROFILE DECRYPTED: " + decrypted);

            // âœ… Step 6: Parse decrypted JSON
            JSONObject decryptedRoot =
                    new JSONObject(decrypted);

            String innerResponseCode =
                    decryptedRoot.optString("response_code", "0");

            if (!innerResponseCode.equals("1")) {
                Log.e("HOME", "Inner response_code not 1");
                return;
            }

            // ðŸ”¥ IMPORTANT: Go inside response â†’ profile
            JSONObject responseObj =
                    decryptedRoot.getJSONObject("response");

            JSONObject profile =
                    responseObj.getJSONObject("profile");

            // âœ… Step 7: Extract profile fields
            String profileId = profile.optString("profileid");
//            String custName = profile.optString("cust_name");
            String clientType = profile.optString("client_type");
            String orgElement = profile.optString("org_element");

            JSONObject account =
                    profile.getJSONObject("accounts")
                            .getJSONArray("account")
                            .getJSONObject(0);

            String accNo = account.optString("acno");
            String custName = profile.optString("cust_name");
            String pan = account.optString("pan");
            String ifsc = account.optString("ifsc_code");

            // âœ… Step 8: Save into SessionManager
            SessionManager session =
                    new SessionManager(this);

            session.saveProfileData(
                    profileId,
                    custName,
                    accNo,
                    pan,
                    ifsc,
                    clientType,
                    orgElement
            );

            Log.d("HOME", "âœ… Profile saved successfully");

        } catch (Exception e) {
            Log.e("HOME", "âŒ Profile parse error", e);
        }
    }
    private void resetIdleTimer() {
        idleHandler.removeCallbacks(idleRunnable);
        idleHandler.postDelayed(idleRunnable, IDLE_TIME);
    }
    private void expireSession() {
        SessionManager session = new SessionManager(this);
        session.setLoggedIn(false);

        // Speak only once, safely
        stopTts();
        speak("Session expired. Please enter MPIN again.");

        idleHandler.removeCallbacks(idleRunnable);

        new Handler().postDelayed(this::redirectToMpin, 1500);
    }

    private void redirectToMpin() {
        startActivity(
                new Intent(this, MpinActivity.class)
                        .setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK)
        );
        finish();
    }

    /* ===================== GESTURES ===================== */

    @Override
    public boolean onTouchEvent(MotionEvent event) {
        idleSpeakCount = 0; // user is active again
        resetIdleTimer();
        return gestureDetector.onTouchEvent(event) || super.onTouchEvent(event);
    }

    private class SwipeListener extends GestureDetector.SimpleOnGestureListener {

        private static final int SWIPE_THRESHOLD = 100;
        private static final int SWIPE_VELOCITY_THRESHOLD = 100;

        @Override
        public boolean onFling(MotionEvent e1, MotionEvent e2,
                               float velocityX, float velocityY) {

            float diffX = e2.getX() - e1.getX();
            float diffY = e2.getY() - e1.getY();

            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (Math.abs(diffX) > SWIPE_THRESHOLD &&
                        Math.abs(velocityX) > SWIPE_VELOCITY_THRESHOLD) {

                    if (diffX > 0) {
                        stopTts();
                        startActivity(new Intent(
                                HomeActivity.this,
                                BalanceMpinActivity.class
                        ));
                        return true;
                    } else {
                        stopTts();
                        startActivity(new Intent(
                                HomeActivity.this,
                                MiniStatementActivity.class
                        ));
                        return true;
                    }
                }
            } else {
                if (Math.abs(diffY) > SWIPE_THRESHOLD &&
                        Math.abs(velocityY) > SWIPE_VELOCITY_THRESHOLD) {

                    if (diffY < 0) {
                        stopTts();
                        startActivity(new Intent(
                                HomeActivity.this,
                                TransactionOptionActivity.class
                        ));
                        return true;
                    }
                }
            }
            return false;
        }
    }

    /* ===================== LIFECYCLE ===================== */

    @Override
    protected void onResume() {
        super.onResume();
        isHomeVisible = true;

        idleSpeakCount = 0;
        speakInstructions();
        resetIdleTimer();
    }


    @Override
    protected void onPause() {
        super.onPause();
        isHomeVisible = false;

        idleHandler.removeCallbacks(idleRunnable);
        stopTts();
    }


    @Override
    protected void onStop() {
        super.onStop();
        stopTts();
    }

    @Override
    protected void onDestroy() {
        if (tts != null) {
            tts.stop();
            tts.shutdown();
        }
        idleHandler.removeCallbacks(idleRunnable);
        super.onDestroy();
    }

}



































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































